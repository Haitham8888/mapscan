<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <title>الخريطة السعودية</title>
    <link rel="stylesheet" href="/static/map.css" />
    <script src="https://js.arcgis.com/4.28/"></script>
</head>
<body>
    <div id="dropdown-container">
        <label for="regions-dropdown">المناطق:</label>
        <select id="regions-dropdown">
            <option value="">اختر منطقة</option>
        </select>

        <label for="cities-dropdown">المدن:</label>
        <select id="cities-dropdown">
            <option value="">اختر مدينة</option>
        </select>

        <label for="districts-dropdown">الأحياء:</label>
        <select id="districts-dropdown">
            <option value="">اختر حي</option>
        </select>
    </div>

    <div id="viewDiv"></div>

    <script>
        // تعبئة القوائم المنسدلة من الـ API
        function populateDropdown(api, elementId) {
            fetch(api)
                .then(res => res.json())
                .then(data => {
                    const select = document.getElementById(elementId);
                    select.innerHTML = "<option value=''>اختر</option>";
                    data.forEach(name => {
                        if (name) {
                            select.innerHTML += `<option value="${name}">${name}</option>`;
                        }
                    });
                })
                .catch(err => {
                    console.error("Error loading", api, err);
                });
        }

        window.addEventListener("load", function () {
            populateDropdown("/api/regions", "regions-dropdown");
            populateDropdown("/api/cities", "cities-dropdown");
            populateDropdown("/api/districts", "districts-dropdown");
        });

        // كود الخريطة ArcGIS
        require([
            "esri/Map",
            "esri/views/MapView",
            "esri/layers/GeoJSONLayer",
            "esri/widgets/Search"
        ], function (Map, MapView, GeoJSONLayer, Search) {

            // IMPORTANT: لازم تكون نفس أسماء الحقول اللي في GeoJSON
            const REGION_NAME_FIELD   = "name_ar";
            const CITY_NAME_FIELD     = "name_ar";
            const DISTRICT_NAME_FIELD = "name_ar";

            // طبقات GeoJSON
            const regionsLayer = new GeoJSONLayer({
                url: "/static/geojson/regions.geojson",
                title: "المناطق",
                outFields: ["*"],
                renderer: {
                    type: "simple",
                    symbol: {
                        type: "simple-fill",
                        color: [46, 204, 64, 0.35],
                        outline: {
                            color: [0, 100, 0, 1],
                            width: 1
                        }
                    }
                }
            });

            const citiesLayer = new GeoJSONLayer({
                url: "/static/geojson/cities.geojson",
                title: "المدن",
                outFields: ["*"],
                renderer: {
                    type: "simple",
                    symbol: {
                        type: "simple-marker",
                        size: 6,
                        color: [0, 116, 217, 1],
                        outline: {
                            color: [255, 255, 255, 1],
                            width: 0.5
                        }
                    }
                }
            });

            const districtsLayer = new GeoJSONLayer({
                url: "/static/geojson/districts.geojson",
                title: "الأحياء",
                outFields: ["*"],
                renderer: {
                    type: "simple",
                    symbol: {
                        type: "simple-fill",
                        color: [255, 195, 0, 0.4],
                        outline: {
                            color: [255, 133, 27, 1],
                            width: 0.5
                        }
                    }
                }
            });

            const map = new Map({
                basemap: "streets",
                layers: [regionsLayer, districtsLayer, citiesLayer]
            });

            const view = new MapView({
                container: "viewDiv",
                map: map,
                center: [45, 24], // وسط السعودية تقريبا
                zoom: 6
            });

            const searchWidget = new Search({ view: view });
            view.ui.add(searchWidget, "top-left");

            // دالة عامة: فلترة الطبقة + zoom
            function filterLayerByName(layer, fieldName, value) {
                if (!value) {
                    layer.definitionExpression = "1=1"; // رجع كل شيء
                    return;
                }

                // فلترة بالاسم
                const safeValue = value.replace(/'/g, "''"); // تهريب الابوستروف
                layer.definitionExpression = `${fieldName} = '${safeValue}'`;

                // Zoom على النتيجة
                layer.when(() => {
                    layer.queryExtent().then(function (res) {
                        if (res.extent) {
                            view.goTo(res.extent.expand(1.2));
                        }
                    });
                });
            }

            // ربط الدروب داون بالماب
            document.getElementById("regions-dropdown").addEventListener("change", function (e) {
                const selected = e.target.value;
                filterLayerByName(regionsLayer, REGION_NAME_FIELD, selected);
            });

            document.getElementById("cities-dropdown").addEventListener("change", function (e) {
                const selected = e.target.value;
                filterLayerByName(citiesLayer, CITY_NAME_FIELD, selected);
            });

            document.getElementById("districts-dropdown").addEventListener("change", function (e) {
                const selected = e.target.value;
                filterLayerByName(districtsLayer, DISTRICT_NAME_FIELD, selected);
            });
        });
    </script>
</body>
</html>
